<html>
<body>

<h3>Civilization-Building Game - Automated Test Suite</h3>

<script type="text/javascript" src="../Source/Base.js"></script>
<script type="text/javascript" src="../Source/Color.js"></script>
<script type="text/javascript" src="../Source/Command.js"></script>
<script type="text/javascript" src="../Source/Coords.js"></script>
<script type="text/javascript" src="../Source/Direction.js"></script>
<script type="text/javascript" src="../Source/DisplayCanvas.js"></script>
<script type="text/javascript" src="../Source/DisplayText.js"></script>
<script type="text/javascript" src="../Source/Government.js"></script>
<script type="text/javascript" src="../Source/IdHelper.js"></script>
<script type="text/javascript" src="../Source/InputHelper.js"></script>
<script type="text/javascript" src="../Source/MapOfCells.js"></script>
<script type="text/javascript" src="../Source/Owner.js"></script>
<script type="text/javascript" src="../Source/ResourceProduction.js"></script>
<script type="text/javascript" src="../Source/SelectableCategory.js"></script>
<script type="text/javascript" src="../Source/Technology.js"></script>
<script type="text/javascript" src="../Source/Unit.js"></script>
<script type="text/javascript" src="../Source/Universe.js"></script>
<script type="text/javascript" src="../Source/World.js"></script>

<script type="text/javascript" src="Mocks.js"></script>

<script type="text/javascript">

class Assert
{
	static areEqual(expected, actual)
	{
		if (actual != expected)
		{
			throw new Error("Expected: '" + expected + "', but was: '" + actual + "'.");
		}
	}

	static areNotEqual(expected, actual)
	{
		if (actual == expected)
		{
			throw new Error("Expected: not equal, but was: equal.");
		}
	}

	static fail(message)
	{
		throw new Error(message);
	}

	static isFalse(expressionToTest)
	{
		if (expressionToTest == true)
		{
			throw new Error("Expected: false, but was: true.");
		}
	}

	static isNotNull(expressionToTest)
	{
		if (expressionToTest == null)
		{
			throw new Error("Expected: not null, but was: null.");
		}
	}

	static isNull(expressionToTest)
	{
		if (expressionToTest != null)
		{
			throw new Error("Expected: null, but was: not null.");
		}
	}

	static isTrue(expressionToTest)
	{
		if (expressionToTest == false)
		{
			throw new Error("Expected: true, but was: false.");
		}
	}
}

class TestSuite
{
	constructor(tests)
	{
		this.tests = tests;
	}

	run()
	{
		var testsCount = this.tests.length;
		var testsPassedSoFarCount = 0;
		var newline = "<br />";

		for (var i = 0; i < testsCount; i++)
		{
			var test = this.tests[i];
			try
			{
				test.run();
				testsPassedSoFarCount++;
				document.write("Test passed: " + test.name + newline);
			}
			catch (ex)
			{
				document.write("Test '" + test.name + "' failed with error:");
				document.write(newline);
				document.write(ex.stack);
				document.write(newline);

				throw ex;
			}
		}

		document.write(newline);

		var testsFailedCount = testsCount - testsPassedSoFarCount;

		if (testsFailedCount == 0)
		{
			document.write("All " + testsCount + " test(s) passed!");
		}
		else
		{
			document.write("Tests failed: " + testsFailedCount + "/" + testsCount);
		}
	}
}

class Test
{
	constructor(name, run)
	{
		this.name = name;
		this._run = run;
	}

	run()
	{
		this._run();
	}
}

// Run.

var testSuite = new TestSuite
([
	new Test
	(
		"PlayDemoFromStart",
		() =>
		{
			var display = new DisplayMock();
			var inputHelper = new InputHelperMock();
			var outputLog = new OutputLogMock();
			var world = World.demo();
			var universe = new Universe(display, inputHelper, outputLog, world);
			universe.initialize();

			// Make sure that owner 0 is selected at startup.
			var owner = world.ownerCurrent();
			Assert.isNotNull(owner);
			var owner0 = world.owners[0];
			Assert.areEqual(owner0, owner);

			// Make sure a settlers unit is selected at startup.
			var unit = owner.unitSelected();
			Assert.isNotNull(unit);
			var unitDefns = UnitDefn.Instances();
			var unitDefnSettlers = unitDefns.Settlers;
			Assert.areEqual(unitDefnSettlers.name, unit.defnName);

			// Make sure the unit has moves initially.
			Assert.isTrue(unit.movesThisTurn() > 0);

			// Count the number of known cells before the move.
			var owner0MapKnowledge = owner0.mapKnowledge;
			var cellsKnownIndices = owner0MapKnowledge.cellsKnownIndicesByIndex;
			var cellsKnownCountBeforeMove = cellsKnownIndices.size;

			// Move the unit.
			var unitPosBeforeMove = unit.pos.clone();
			var directions = Direction.Instances();
			var east = directions.East;
			var directionToMove = east;
			unit.moveInDirection(directionToMove, world);

			// Make sure the unit has used up its moves.
			Assert.isFalse(unit.hasMovesThisTurn());

			// Make sure the unit's position has changed by the correct offset.
			var unitPosAfterMove = unit.pos.clone();
			var offsetMoved = unitPosAfterMove.clone().subtract(unitPosBeforeMove);
			Assert.isTrue(offsetMoved.equals(directionToMove.offset));

			// Make sure that more cells are known.
			var cellsKnownCountAfterMove = cellsKnownIndices.size;
			Assert.isTrue(cellsKnownCountAfterMove > cellsKnownCountBeforeMove);

			// Attempt to advance to the next idle unit (but there isn't one).
			owner.unitSelectNextIdle();
			unit = owner.unitSelected();
			Assert.isNull(unit);

			// End the first owner's turn.
			var ownerBeforeEndingTurn = owner;
			world.ownerCurrentAdvance(universe);

			// Make sure the current owner has changed.
			var ownerAfterEndingTurn = world.ownerCurrent();
			Assert.areNotEqual(ownerAfterEndingTurn, ownerBeforeEndingTurn);

			// End the second owner's turn, which ends the round.
			var turnsBeforeEndingRound = world.turnsSoFar;
			Assert.areEqual(0, turnsBeforeEndingRound);
			world.ownerCurrentAdvance(universe);
			var turnsAfterEndingRound = world.turnsSoFar;
			Assert.areEqual(1, turnsAfterEndingRound);

			// Make sure owner 0 is the current one again.
			var ownerAfterEndingRound = world.ownerCurrent();
			Assert.areEqual(owner0, ownerAfterEndingRound);

			// Found a city with the settlers.
			owner = ownerAfterEndingRound;
			var unit = owner.unitSelected();
			var activityDefns = UnitActivityDefn.Instances();
			var activityBefore = unit.activity;
			Assert.isNull(activityBefore);
			unit.activityStart(activityDefns.SettlersStartCity, world);

			// Verify that the settlers have disappeared, and become a base.
			Assert.areEqual(0, owner.units.length);
			Assert.areEqual(1, owner.bases.length);

			// Verify that the base is as expected.
			var owner0Base0 = owner.bases[0];
			var base = owner0Base0;
			Assert.isTrue(base.pos.equals(unit.pos) );
			var basePopulationInitial = base.population;
			Assert.areEqual(1, basePopulationInitial);
			Assert.areEqual(2, base.landUsage.offsetsInUse.length);
			Assert.isTrue(base.isIdle() );
			var resourcesThisTurn = base.resourcesProducedThisTurn(world, base);
			var resourcesNone = ResourceProduction.create();
			Assert.isFalse(resourcesThisTurn.equals(resourcesNone) );
			var map = world.map;
			var cell = map.cellAtPosInCells(base.pos);
			Assert.isTrue(cell.hasIrrigation());
			Assert.isTrue(cell.hasRoads());

			// Advance the turn and make sure some resources are being produced,
			// but not any industry, because there's no project.
			world.turnAdvance();
			resourcesThisTurn = base.resourcesProducedThisTurn();
			Assert.isFalse(resourcesThisTurn.equals(resourcesNone ) );
			var industryStockpiled = base.industry.industryStockpiled;
			Assert.areEqual(0, industryStockpiled);

			// Wait for the population to grow.
			var turnsToWaitMax = 100;
			var foodNeededToGrow = base.foodNeededToGrow();
			var foodPerTurn = base.foodThisTurnNet(world);
			var turnsToWait = Math.ceil(foodNeededToGrow / foodPerTurn);
			Assert.isTrue(turnsToWait < turnsToWaitMax);
			world.turnAdvanceMultiple(turnsToWait);
			Assert.areNotEqual(basePopulationInitial, base.population);

			// Start building a new settlers unit.
			base.buildableStart(unitDefnSettlers, world);
			Assert.isFalse(base.isIdle() );

			var industryPerTurn = resourcesThisTurn.industry;
			turnsToWait = Math.ceil
			(
				unitDefnSettlers.industryToBuild / industryPerTurn
			);
			Assert.isFalse(turnsToWait > turnsToWaitMax);

			var turnsWaitedSoFar = 0;
			while (base.isBuildingSomething())
			{
				// Advance the turn and make sure some industry has accrued.
				world.turnAdvance();
				var industryStockpiled = base.industry.industryStockpiled;
				Assert.areNotEqual(0, industryStockpiled);

				turnsWaitedSoFar++;
				if (turnsWaitedSoFar > turnsToWaitMax)
				{
					Assert.fail("Waited too many turns!");
				}
			}

			// Make sure the settlers unit has been built as expected.
			Assert.areEqual(1, owner.units.length);
			unit = owner.units[0];
			Assert.areEqual(unit.defnName, unitDefns.Settlers.name);
			Assert.isTrue(unit.pos.equals(base.pos));
			Assert.areEqual(unit, owner.unitSelected());
			Assert.areNotEqual(0, unit.movesThisTurn());

			// Move the settler one cell and irrigate.
			unit.moveInDirection(east, world);
			world.turnAdvance();
			var activityDefn = activityDefns.SettlersBuildIrrigation;
			unit.activityStart(activityDefn, world);

			// Make sure the irrigation doesn't show up instantly.
			cell = map.cellAtPosInCells(unit.pos);
			var cellHasIrrigation = cell.hasIrrigation();
			Assert.isFalse(cellHasIrrigation);

			// Wait for the irrigation task to complete.
			turnsToWaitExpected =
				activityDefn.movesToComplete / unitDefnSettlers.movesPerTurn();
			Assert.isTrue(turnsToWaitExpected < turnsToWaitMax);
			world.turnAdvanceMultiple(turnsToWaitExpected);

			// Make sure the irrigation appeared.
			cell = map.cellAtPosInCells(unit.pos);
			cellHasIrrigation = cell.hasIrrigation();
			Assert.isTrue(cellHasIrrigation);

			// Build some roads.
			var activityDefn = activityDefns.SettlersBuildRoads;
			unit.activityStart(activityDefn, world);

			// Make sure the roads don't show up instantly.
			cell = map.cellAtPosInCells(unit.pos);
			var cellHasRoads = cell.hasRoads();
			Assert.isFalse(cellHasRoads);

			// Wait for the road-building task to complete.
			turnsToWaitExpected =
				activityDefn.movesToComplete / unitDefnSettlers.movesPerTurn();
			Assert.isTrue(turnsToWaitExpected < turnsToWaitMax);
			world.turnAdvanceMultiple(turnsToWaitExpected);

			// Make sure the roads appeared.
			cell = map.cellAtPosInCells(unit.pos);
			cellHasRoads = cell.hasRoads();
			Assert.isTrue(cellHasRoads);

			// Re-optimize the base's land usage.
			var resourcesBeforeOptimize = base.resourcesProducedThisTurn().clone();
			base.landUsageOptimize(world);
			var resourcesAfterOptimize =
				base.resourcesProducedThisTurn(world);
			Assert.isFalse(resourcesAfterOptimize.equals(resourcesBeforeOptimize) );

			world.turnAdvance(); // hack - Should this be necessary?

			// Move the settlers back into the city and out again,
			// then make sure a third of a move remains.
			var west = directions.West;
			unit.moveInDirection(west, world);
			unit.moveInDirection(east, world);
			Assert.isTrue(unit.hasMovesThisTurn());
			Assert.areEqual(1, unit.moveThirdsThisTurn);

			// Try to move the unit off the road,
			// but it can't, because it only has 1/3 move left. 
			var unitPosBeforeMoveAttempt = unit.pos.clone();
			unit.moveInDirection(east, world);
			Assert.isTrue(unit.pos.equals(unitPosBeforeMoveAttempt) );

			// End the turn and try again, it should work now.
			world.turnAdvance();
			unitPosBeforeMoveAttempt = unit.pos.clone();
			unit.moveInDirection(east, world);
			Assert.isFalse(unit.pos.equals(unitPosBeforeMoveAttempt) );

			// Select a tech to research.
			var techsAll = Technology.Instances();
			var techsResearchable = owner0.technologiesResearchable();
			Assert.areNotEqual(0, techsResearchable.length);
			var techToResearch =
				techsResearchable.find(x => x == techsAll.Pottery);
			owner0.technologyResearch(techToResearch);

			// Make sure that the base can't build the improvement yet.
			var buildablesAvailableNames =
				base.buildablesAvailableNames(world);
			Assert.areNotEqual(0, buildablesAvailableNames.length);
			var baseImprovementDefns = BaseImprovementDefn.Instances();
			var improvementToBuild = baseImprovementDefns.Granary;
			var canBuildImprovement =
				buildablesAvailableNames.indexOf(improvementToBuild.name) >= 0;
			Assert.isFalse(canBuildImprovement);

			// Wait for the research to complete.
			var researchPerTurn = owner.researchThisTurn(world);
			var turnsExpectedToResearch = Math.ceil
			(
				techToResearch.researchToLearn / researchPerTurn
			);
			Assert.isTrue(turnsExpectedToResearch < turnsToWaitMax);
			world.turnAdvanceMultiple(turnsExpectedToResearch);

			// Make sure the researched tech is now known, and no longer researchable.
			var techsKnown = owner.technologiesKnown();
			Assert.isTrue(techsKnown.indexOf(techToResearch) >= 0);
			techsResearchable = owner.technologiesResearchable();
			Assert.isTrue(techsResearchable.indexOf(techToResearch) == -1);

			// Make sure that the base can build the improvement now.
			buildablesAvailableNames =
				base.buildablesAvailableNames(world);
			canBuildImprovement =
				buildablesAvailableNames.indexOf(improvementToBuild.name) >= 0;
			Assert.isTrue(canBuildImprovement);

			// Start building the improvement.
			base.buildableStart(improvementToBuild, world);
			var industryPerTurn = base.industryThisTurnNet(world);
			var turnsToWait = Math.ceil(improvementToBuild.industryToBuild / industryPerTurn);
			Assert.isTrue(turnsToWait < turnsToWaitMax);
			world.turnAdvanceMultiple(turnsToWait);

			// Make sure that the base now contains the improvement.
			Assert.isTrue(base.hasImprovement(improvementToBuild));

		}
	)
]);

testSuite.run();

</script>

</body>
</html>
