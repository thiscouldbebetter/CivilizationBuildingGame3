<html>
<body>

<h3>Civilization-Building Game - Automated Test Suite</h3>

<script type="text/javascript" src="../Source/Base.js"></script>
<script type="text/javascript" src="../Source/Color.js"></script>
<script type="text/javascript" src="../Source/Command.js"></script>
<script type="text/javascript" src="../Source/Coords.js"></script>
<script type="text/javascript" src="../Source/Direction.js"></script>
<script type="text/javascript" src="../Source/Display.js"></script>
<script type="text/javascript" src="../Source/IdHelper.js"></script>
<script type="text/javascript" src="../Source/InputHelper.js"></script>
<script type="text/javascript" src="../Source/MapOfCells.js"></script>
<script type="text/javascript" src="../Source/Owner.js"></script>
<script type="text/javascript" src="../Source/ResourceProduction.js"></script>
<script type="text/javascript" src="../Source/SelectableCategory.js"></script>
<script type="text/javascript" src="../Source/Technology.js"></script>
<script type="text/javascript" src="../Source/Unit.js"></script>
<script type="text/javascript" src="../Source/Universe.js"></script>
<script type="text/javascript" src="../Source/World.js"></script>

<script type="text/javascript" src="Mocks.js"></script>

<script type="text/javascript">

class Assert
{
	static areEqual(expected, actual)
	{
		if (actual != expected)
		{
			throw new Error("Expected: '" + expected + "', but was: '" + actual + "'.");
		}
	}

	static areNotEqual(expected, actual)
	{
		if (actual == expected)
		{
			throw new Error("Expected: not equal, but was: equal.");
		}
	}

	static fail(message)
	{
		throw new Error(message);
	}

	static isFalse(expressionToTest)
	{
		if (expressionToTest == true)
		{
			throw new Error("Expected: false, but was: true.");
		}
	}

	static isNotNull(expressionToTest)
	{
		if (expressionToTest == null)
		{
			throw new Error("Expected: not null, but was: null.");
		}
	}

	static isNull(expressionToTest)
	{
		if (expressionToTest != null)
		{
			throw new Error("Expected: null, but was: not null.");
		}
	}

	static isTrue(expressionToTest)
	{
		if (expressionToTest == false)
		{
			throw new Error("Expected: true, but was: false.");
		}
	}
}

class TestSuite
{
	constructor(tests)
	{
		this.tests = tests;
	}

	run()
	{
		var testsCount = this.tests.length;
		var testsPassedSoFarCount = 0;
		var newline = "<br />";

		for (var i = 0; i < testsCount; i++)
		{
			var test = this.tests[i];
			try
			{
				test.run();
				testsPassedSoFarCount++;
				document.write("Test passed: " + test.name + newline);
			}
			catch (ex)
			{
				document.write("Test '" + test.name + "' failed with error:");
				document.write(newline);
				document.write(ex.stack);
				document.write(newline);

				throw ex;
			}
		}

		document.write(newline);

		var testsFailedCount = testsCount - testsPassedSoFarCount;

		if (testsFailedCount == 0)
		{
			document.write("All " + testsCount + " test(s) passed!");
		}
		else
		{
			document.write("Tests failed: " + testsFailedCount + "/" + testsCount);
		}
	}
}

class Test
{
	constructor(name, run)
	{
		this.name = name;
		this._run = run;
	}

	run()
	{
		this._run();
	}
}

// Run.

var testSuite = new TestSuite
([
	new Test
	(
		"PlayDemoFromStart",
		() =>
		{
			var display = new DisplayMock();
			var inputHelper = new InputHelperMock();
			var outputLog = new OutputLogMock();
			var world = World.demo();
			var universe = new Universe(display, inputHelper, outputLog, world);
			universe.initialize();

			// Make sure that owner 0 is selected at startup.
			var owner = world.ownerCurrent();
			Assert.isNotNull(owner);
			var owner0 = world.owners[0];
			Assert.areEqual(owner0, owner);

			// Make sure a settlers unit is selected at startup.
			var unit = owner.unitSelected();
			Assert.isNotNull(unit);
			var unitDefns = UnitDefn.Instances();
			var unitDefnSettlers = unitDefns.Settlers;
			Assert.areEqual(unitDefnSettlers.name, unit.defnName);

			// Make sure the unit has moves initially.
			Assert.isTrue(unit.movesThisTurn > 0);

			// Move the unit.
			var unitPosBeforeMove = unit.pos.clone();
			var directions = Direction.Instances();
			var east = directions.East;
			var directionToMove = east;
			unit.moveInDirection(directionToMove, world);

			// Make sure the unit has used up its moves.
			Assert.isTrue(unit.movesThisTurn == 0);

			// Make sure the unit's position has changed by the correct offset.
			var unitPosAfterMove = unit.pos.clone();
			var offsetMoved = unitPosAfterMove.clone().subtract(unitPosBeforeMove);
			Assert.isTrue(offsetMoved.equals(directionToMove.offset));

			// Attempt to advance to the next idle unit (but there isn't one).
			owner.unitSelectNextIdle();
			unit = owner.unitSelected();
			Assert.isNull(unit);

			// End the first owner's turn.
			var ownerBeforeEndingTurn = owner;
			world.ownerCurrentAdvance(universe);

			// Make sure the current owner has changed.
			var ownerAfterEndingTurn = world.ownerCurrent();
			Assert.areNotEqual(ownerAfterEndingTurn, ownerBeforeEndingTurn);

			// End the second owner's turn, which ends the round.
			var turnsBeforeEndingRound = world.turnsSoFar;
			Assert.areEqual(0, turnsBeforeEndingRound);
			world.ownerCurrentAdvance(universe);
			var turnsAfterEndingRound = world.turnsSoFar;
			Assert.areEqual(1, turnsAfterEndingRound);

			// Make sure owner 0 is the current one again.
			var ownerAfterEndingRound = world.ownerCurrent();
			Assert.areEqual(owner0, ownerAfterEndingRound);

			// Found a city with the settlers.
			owner = ownerAfterEndingRound;
			var unitSettlers = owner.unitSelected();
			var activityDefns = UnitActivityDefn.Instances();
			var activityBefore = unitSettlers.activity;
			Assert.isNull(activityBefore);
			unitSettlers.activityStart(activityDefns.SettlersStartCity, world);

			// Verify that the settlers have disappeared, and become a base.
			Assert.areEqual(0, owner.units.length);
			Assert.areEqual(1, owner.bases.length);

			// Verify that the base is as expected.
			var owner0Base0 = owner.bases[0];
			var base = owner0Base0;
			Assert.isTrue(base.pos.equals(unitSettlers.pos) );
			Assert.areEqual(1, base.population);
			Assert.areEqual(2, base.landUsage.offsetsInUse.length);
			Assert.isTrue(base.isIdle() );
			var resourcesThisTurn = base.resourcesProducedThisTurn();
			var resourcesNone = ResourceProduction.create();
			Assert.isTrue(resourcesThisTurn.equals(resourcesNone) );
			var map = world.map;
			var cell = map.cellAtPosInCells(base.pos);
			Assert.isTrue(cell.hasIrrigation());
			Assert.isTrue(cell.hasRoads());

			// Advance the turn and make sure some resources were produced,
			// but not any industry, because there's no project.
			world.turnAdvance();
			resourcesThisTurn = base.resourcesProducedThisTurn();
			Assert.isFalse(resourcesThisTurn.equals(resourcesNone ) );
			var industryStockpiled = base.industry.industryStockpiled;
			Assert.areEqual(0, industryStockpiled);

			// Start building a new settlers unit.
			base.buildableBuildByDefnName(unitDefnSettlers.name, world, owner);
			Assert.isFalse(base.isIdle() );

			var industryPerTurn = resourcesThisTurn.industry;
			var turnsToWaitExpected = Math.ceil
			(
				unitDefnSettlers.industryToBuild / industryPerTurn
			);
			var turnsWaitedSoFar = 0;
			var turnsToWaitMax = 100;
			while (base.isBuildingSomething())
			{
				// Advance the turn and make sure some industry has accrued.
				world.turnAdvance();
				var industryStockpiled = base.industry.industryStockpiled;
				Assert.areNotEqual(0, industryStockpiled);

				turnsWaitedSoFar++;
				if (turnsWaitedSoFar > turnsToWaitMax)
				{
					Assert.fail("Waited too many turns!");
				}
			}

			Assert.areEqual(turnsToWaitExpected, turnsWaitedSoFar);

			// Make sure the settlers unit has been built as expected.
			Assert.areEqual(1, owner.units.length);
			unitSettlers = owner.units[0];
			Assert.areEqual(unitSettlers.defnName, unitDefns.Settlers.name);
			Assert.isTrue(unitSettlers.pos.equals(base.pos));
			Assert.areEqual(unitSettlers, owner.unitSelected());
			Assert.areNotEqual(0, unitSettlers.movesThisTurn);

			// Move the settler one cell and irrigate
			unitSettlers.moveInDirection(east, world);
			world.turnAdvance();
			cell = map.cellAtPosInCells(unitSettlers.pos);
			var activityDefn = activityDefns.SettlersBuildIrrigation;
			unitSettlers.activityStart(activityDefn, world);

			// Make sure the irrigation doesn't show up instantly.
			cell = map.cellAtPosInCells(unitSettlers.pos);
			var cellHasIrrigation = cell.hasIrrigation();
			Assert.isFalse(cellHasIrrigation);

			// Wait for the irrigation task to complete.
			turnsToWaitExpected =
				activityDefn.movesToComplete / unitDefnSettlers.movesPerTurn();
			Assert.isTrue(turnsToWaitExpected < turnsToWaitMax);
			world.turnAdvanceMultiple(turnsToWaitExpected);

			// Make sure the irrigation appeared.
			cell = map.cellAtPosInCells(unitSettlers.pos);
			cellHasIrrigation = cell.hasIrrigation();
			Assert.isTrue(cellHasIrrigation);
		}
	)
]);

testSuite.run();

</script>

</body>
</html>
